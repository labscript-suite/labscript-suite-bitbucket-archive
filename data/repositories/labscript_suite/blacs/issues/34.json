{"priority": "critical", "kind": "bug", "repository": {"links": {"self": {"href": "data/repositories/labscript_suite/blacs.json"}, "html": {"href": "#!/labscript_suite/blacs"}, "avatar": {"href": "data/bytebucket.org/ravatar/{50ed1eb9-8c1b-4afe-a8b8-8e0a33b39a05}ts=249915"}}, "type": "repository", "name": "BLACS", "full_name": "labscript_suite/blacs", "uuid": "{50ed1eb9-8c1b-4afe-a8b8-8e0a33b39a05}"}, "links": {"attachments": {"href": "data/repositories/labscript_suite/blacs/issues/34/attachments_page=1.json"}, "self": {"href": "data/repositories/labscript_suite/blacs/issues/34.json"}, "watch": {"href": "https://api.bitbucket.org/2.0/repositories/labscript_suite/blacs/issues/34/watch"}, "comments": {"href": "data/repositories/labscript_suite/blacs/issues/34/comments_page=1.json"}, "html": {"href": "#!/labscript_suite/blacs/issues/34/calls-to-transition_to_manual-are"}, "vote": {"href": "https://api.bitbucket.org/2.0/repositories/labscript_suite/blacs/issues/34/vote"}}, "reporter": {"display_name": "Philip Starkey", "uuid": "{48af65db-e5fc-459c-a7eb-52eb1f9a5690}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7B48af65db-e5fc-459c-a7eb-52eb1f9a5690%7D"}, "html": {"href": "https://bitbucket.org/%7B48af65db-e5fc-459c-a7eb-52eb1f9a5690%7D/"}, "avatar": {"href": "data/secure.gravatar.com/avatar/dc318537facc47ebe1ae98a7aabacecfd=httpsavatar-management--avatars.us-west-2.prod.public.atl-paas.netinitialsPS-0.png"}}, "nickname": "pstarkey", "type": "user", "account_id": "557058:52a111e4-40da-4441-9143-417f95f2db97"}, "title": "calls to transition_to_manual are serialised by the queue manager", "component": null, "votes": 0, "watches": 3, "content": {"raw": "Calls to `device.transition_to_manual` by the queue manager are currently serialised.\r\n\r\nI believe this is an artefact of a version of BIAS which did not use zlock/h5lock and would thus cause HDF5 file corruption if BIAS wrote to the file while the lock was held by one of the BLACS devices. However, I believe this is no longer the case (need to double check) and that BIAS uses zlock/h5lock correctly now.\r\n\r\n**Regardless, this introduces an unfortunate error when using multiple acquisition cards with a wait monitor.** \r\nIf the device with the wait monitor is not transitioned to manual prior to all acquisition devices, then those acquisition devices will timeout waiting for the `zprocess.Event` to be issued indicating that waits have been processed (since that processing has not happened yet, and can't until the other acquisition device completes). This is effectively a deadlock, except that fortunately the zprocess event times-out (although then the shot is aborted due to that failure). This of course may work for some people, as the transition order is currently dependent on the iteration order of a dictionary, which is itself dependent on the names of each device in use along with the number of devices in use (see resources on how dictionary hashing works in Python).\r\n\r\nI believe @rpanderson recently experienced this bug when he visited JQI.\r\n\r\nAnyway, the solution is to deserialise `transition_to_manual`", "markup": "markdown", "html": "<p>Calls to <code>device.transition_to_manual</code> by the queue manager are currently serialised.</p>\n<p>I believe this is an artefact of a version of BIAS which did not use zlock/h5lock and would thus cause HDF5 file corruption if BIAS wrote to the file while the lock was held by one of the BLACS devices. However, I believe this is no longer the case (need to double check) and that BIAS uses zlock/h5lock correctly now.</p>\n<p><strong>Regardless, this introduces an unfortunate error when using multiple acquisition cards with a wait monitor.</strong> \nIf the device with the wait monitor is not transitioned to manual prior to all acquisition devices, then those acquisition devices will timeout waiting for the <code>zprocess.Event</code> to be issued indicating that waits have been processed (since that processing has not happened yet, and can't until the other acquisition device completes). This is effectively a deadlock, except that fortunately the zprocess event times-out (although then the shot is aborted due to that failure). This of course may work for some people, as the transition order is currently dependent on the iteration order of a dictionary, which is itself dependent on the names of each device in use along with the number of devices in use (see resources on how dictionary hashing works in Python).</p>\n<p>I believe @rpanderson recently experienced this bug when he visited JQI.</p>\n<p>Anyway, the solution is to deserialise <code>transition_to_manual</code></p>", "type": "rendered"}, "assignee": null, "state": "resolved", "version": null, "edited_on": null, "created_on": "2018-01-24T04:31:40.632878+00:00", "milestone": null, "updated_on": "2019-06-03T03:54:45.595983+00:00", "type": "issue", "id": 34}