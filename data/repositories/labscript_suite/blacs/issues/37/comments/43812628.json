{"links": {"self": {"href": "data/repositories/labscript_suite/blacs/issues/37/comments/43812628.json"}, "html": {"href": "#!/labscript_suite/blacs/issues/37#comment-43812628"}}, "issue": {"links": {"self": {"href": "data/repositories/labscript_suite/blacs/issues/37.json"}}, "type": "issue", "id": 37, "repository": {"links": {"self": {"href": "data/repositories/labscript_suite/blacs.json"}, "html": {"href": "#!/labscript_suite/blacs"}, "avatar": {"href": "data/bytebucket.org/ravatar/{50ed1eb9-8c1b-4afe-a8b8-8e0a33b39a05}ts=249915"}}, "type": "repository", "name": "BLACS", "full_name": "labscript_suite/blacs", "uuid": "{50ed1eb9-8c1b-4afe-a8b8-8e0a33b39a05}"}, "title": "Changing unitconversion parameters sets all frontpanel values to 0"}, "content": {"raw": "Firstly, I just want to say that it should not lose **all** values. That is clearly a regression that must have been introduced recently. Only those that have changed should be lost at the very least. I can see how certain ones may be lost (due to the reasons outlined below), but not why all of the values would be lost. So it's possible that there are multiple issues here that we need to untangle.\n\nI suspect a lot of the failures (like this and maybe #36) are due to the somewhat outdated code in [blacs/front_panel_settings.py](#!/labscript_suite/blacs/src/66a107e63fc012badd8b7049b5f26a145eac2d78/front_panel_settings.py?at=default&fileviewer=file-view-default#front_panel_settings.py-46).\n\nIf we look at the comments for the algorithm, it looks like it's only excepting changed to the parent device and connected port when determining whether to restore a value or not. Now, it's possible that the comments are out of date, but it's also possible that we need to more complicated exception code for the other, more recent, columns in the connection table. \n\nFor example:\n\n* a change in unit conversion probably shouldn't result in a reset of the value because the value is stored in base_units and so the actual physical value that is output by the device/channel will not change even if the unit conversion does.\n\n* Changes in shutter open state or inverted digital state probably should result in the default being restored.\n\nWe probably need to look at what other things could invalidate the connection table comparison (what else is stored in the columns that carry dictionaries/JSON?) and come up with some general rules for when to restore or not to restore. \n\nOriginally I planned to prompt for the user to choose what to restore or not to restore when there were conflicts, but that never eventuated. That's probably a bit hard to implement at the moment without significant changes to the BLACS startup algorithm (which probably needs to happen anyway, see #8)", "markup": "markdown", "html": "<p>Firstly, I just want to say that it should not lose <strong>all</strong> values. That is clearly a regression that must have been introduced recently. Only those that have changed should be lost at the very least. I can see how certain ones may be lost (due to the reasons outlined below), but not why all of the values would be lost. So it's possible that there are multiple issues here that we need to untangle.</p>\n<p>I suspect a lot of the failures (like this and maybe <a href=\"#!/labscript_suite/blacs/issues/36/front-panel-settings-not-loaded-correctly\" rel=\"nofollow\" title=\"front panel settings not loaded correctly if blacs is not run as a module\" class=\"ap-connect-link\"><s>#36</s></a>) are due to the somewhat outdated code in <a data-is-external-link=\"true\" href=\"#!/labscript_suite/blacs/src/66a107e63fc012badd8b7049b5f26a145eac2d78/front_panel_settings.py?at=default&amp;fileviewer=file-view-default#front_panel_settings.py-46\" rel=\"nofollow\">blacs/front_panel_settings.py</a>.</p>\n<p>If we look at the comments for the algorithm, it looks like it's only excepting changed to the parent device and connected port when determining whether to restore a value or not. Now, it's possible that the comments are out of date, but it's also possible that we need to more complicated exception code for the other, more recent, columns in the connection table. </p>\n<p>For example:</p>\n<ul>\n<li>\n<p>a change in unit conversion probably shouldn't result in a reset of the value because the value is stored in base_units and so the actual physical value that is output by the device/channel will not change even if the unit conversion does.</p>\n</li>\n<li>\n<p>Changes in shutter open state or inverted digital state probably should result in the default being restored.</p>\n</li>\n</ul>\n<p>We probably need to look at what other things could invalidate the connection table comparison (what else is stored in the columns that carry dictionaries/JSON?) and come up with some general rules for when to restore or not to restore. </p>\n<p>Originally I planned to prompt for the user to choose what to restore or not to restore when there were conflicts, but that never eventuated. That's probably a bit hard to implement at the moment without significant changes to the BLACS startup algorithm (which probably needs to happen anyway, see <a href=\"#!/labscript_suite/blacs/issues/8/compile-and-restart-improvements-making\" rel=\"nofollow\" title=\"&#39;Compile and restart&#39; improvements - making sure it can happen when other things are borked\" class=\"ap-connect-link\"><s>#8</s></a>)</p>", "type": "rendered"}, "created_on": "2018-03-09T11:20:50.640669+00:00", "user": {"display_name": "Philip Starkey", "uuid": "{48af65db-e5fc-459c-a7eb-52eb1f9a5690}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7B48af65db-e5fc-459c-a7eb-52eb1f9a5690%7D"}, "html": {"href": "https://bitbucket.org/%7B48af65db-e5fc-459c-a7eb-52eb1f9a5690%7D/"}, "avatar": {"href": "data/secure.gravatar.com/avatar/dc318537facc47ebe1ae98a7aabacecfd=httpsavatar-management--avatars.us-west-2.prod.public.atl-paas.netinitialsPS-0.png"}}, "nickname": "pstarkey", "type": "user", "account_id": "557058:52a111e4-40da-4441-9143-417f95f2db97"}, "updated_on": null, "type": "issue_comment", "id": 43812628}