{"links": {"self": {"href": "data/repositories/labscript_suite/blacs/pullrequests/67/comments/100224954.json"}, "html": {"href": "#!/labscript_suite/blacs/pull-requests/67/_/diff#comment-100224954"}}, "deleted": false, "pullrequest": {"type": "pullrequest", "id": 67, "links": {"self": {"href": "data/repositories/labscript_suite/blacs/pullrequests/67.json"}, "html": {"href": "#!/labscript_suite/blacs/pull-requests/67"}}, "title": "Implement remote workers in BLACS"}, "content": {"raw": "There's ill-defined behaviour when `labscript_utils.remote` is terminated \\(by pressing Ctrl \\+ C or Q in the `zprocess.remote` terminal\\):\n\n1. There\u2019s no indication in blacs that this has happened.\n2. Shots subsequently added to the queue actually run \\(!\\).\n3. Clicking on the restart icon results in:\n\n    * No change to the tab \\(including state\\) for about 5 seconds;\n    * The whole blacs GUI hanging for about 5-10 seconds;\n    * An unhandled `zprocess.utils.TimeoutError`in a pop-up rather than the tab.\n    \n\n![](data/bitbucket.org/repo/dR5qxr/images/1115376628-ruHyqp9Cst.gif)\n\u200c\n\nDismissing the exception dialogue, the tab still appears to be alive \\(green tick in corner, state: idle\\). Shots can be added to the queue and still run, i.e. item 2 above is persistent.\n\nLooking into item \\(2\\) above:\n\nWhen first starting `labscript_utils.remote`, the following Python processes begin \\(indentation denotes sub-process\\):\n\n* `python -m labscript_utils.remote`\n\n    * `C:\\ProgramData\\Anaconda3\\python.exe -m zprocess.remote --port 7341 -tui --shared_secret_file <path_to_shared_secret>`\n    \n        * `C:\\ProgramData\\Anaconda3\\python.exe -m zprocess.process_class_wrapper --zprocess-parentinfo \"{\\\"parent_host\\\": \\\"192.168.0.3\\\", \\\"to_parent_port\\\": 54791, \\\"from_parent_port\\\": 54793, \\\"heartbeat_server_host\\\": \\\"192.168.0.3\\\", \\\"heartbeat_server_port\\\": 54544, \\\"broker_host\\\": \\\"192.168.0.3\\\", \\\"broker_in_port\\\": 54502, \\\"broker_out_port\\\": 54503, \\\"output_redirection_host\\\": \\\"192.168.0.3\\\", \\\"output_redirection_port\\\": 54774, \\\"shared_secret\\\": \\\"ZDUys7s8lM22F9epAIGeD2KyoSAcygaXaJrQ5w0/k2LHVpeK6thnofXN4C287U41K/3j6TX74zbLLlBx7dx6IA==\\\", \\\"allow_insecure\\\": false, \\\"zlock_host\\\": \\\"192.168.0.3\\\", \\\"zlock_port\\\": \\\"7339\\\", \\\"zlock_process_name\\\": \\\"BLACS\\\", \\\"zlog_host\\\": \\\"192.168.0.3\\\", \\\"zlog_port\\\": 7340, \\\"log_paths\\\": {\\\"BLACS\\\": \\\"C:\\\\labscript_suite\\\\BLACS\\\\BLACS.log\\\"}}\"`\n        \n    \n\nThe final process begins only upon connection to the `zprocess.remote` server by the blacs tab, and is not terminated when the two parent processes are \\(which is why shots can still run\\).\n\nUpon killing the rogue process:\n\n1. There\u2019s no indication in blacs that this has happened.\n2. Shots added to the queue fail to run, getting stuck in \u2018State: \\_transition\\_to\\_buffered \\(GUI\\)\u2019 and halting the queue indefinitely.\n3. Attempting to restart the tab while in this state results in similar observations to \\(3\\) above, except that the tab remains in the hung state after dismissing the `zprocess.utils.TimeoutError`.\n4. If instead of \\(2\\), the tab is attempted to be restarted \\(before any shots are added\\), the tab gets stuck in the following state indefinitely:\n\n![](data/bitbucket.org/repo/dR5qxr/images/1926582354-camera0.png)\n\u200c\n\nIn any case, if the rogue process is killed and any of items \\(2\\)-\\(4\\) above are observed, blacs must be restarted entirely.", "markup": "markdown", "html": "<p>There's ill-defined behaviour when <code>labscript_utils.remote</code> is terminated (by pressing Ctrl + C or Q in the <code>zprocess.remote</code> terminal):</p>\n<ol>\n<li>There\u2019s no indication in blacs that this has happened.</li>\n<li>Shots subsequently added to the queue actually run (!).</li>\n<li>\n<p>Clicking on the restart icon results in:</p>\n<ul>\n<li>No change to the tab (including state) for about 5 seconds;</li>\n<li>The whole blacs GUI hanging for about 5-10 seconds;</li>\n<li>An unhandled <code>zprocess.utils.TimeoutError</code>in a pop-up rather than the tab.</li>\n</ul>\n</li>\n</ol>\n<p><img alt=\"\" src=\"data/bitbucket.org/repo/dR5qxr/images/1115376628-ruHyqp9Cst.gif\" />\n\u200c</p>\n<p>Dismissing the exception dialogue, the tab still appears to be alive (green tick in corner, state: idle). Shots can be added to the queue and still run, i.e. item 2 above is persistent.</p>\n<p>Looking into item (2) above:</p>\n<p>When first starting <code>labscript_utils.remote</code>, the following Python processes begin (indentation denotes sub-process):</p>\n<ul>\n<li>\n<p><code>python -m labscript_utils.remote</code></p>\n<ul>\n<li>\n<p><code>C:\\ProgramData\\Anaconda3\\python.exe -m zprocess.remote --port 7341 -tui --shared_secret_file &lt;path_to_shared_secret&gt;</code></p>\n<ul>\n<li><code>C:\\ProgramData\\Anaconda3\\python.exe -m zprocess.process_class_wrapper --zprocess-parentinfo \"{\\\"parent_host\\\": \\\"192.168.0.3\\\", \\\"to_parent_port\\\": 54791, \\\"from_parent_port\\\": 54793, \\\"heartbeat_server_host\\\": \\\"192.168.0.3\\\", \\\"heartbeat_server_port\\\": 54544, \\\"broker_host\\\": \\\"192.168.0.3\\\", \\\"broker_in_port\\\": 54502, \\\"broker_out_port\\\": 54503, \\\"output_redirection_host\\\": \\\"192.168.0.3\\\", \\\"output_redirection_port\\\": 54774, \\\"shared_secret\\\": \\\"ZDUys7s8lM22F9epAIGeD2KyoSAcygaXaJrQ5w0/k2LHVpeK6thnofXN4C287U41K/3j6TX74zbLLlBx7dx6IA==\\\", \\\"allow_insecure\\\": false, \\\"zlock_host\\\": \\\"192.168.0.3\\\", \\\"zlock_port\\\": \\\"7339\\\", \\\"zlock_process_name\\\": \\\"BLACS\\\", \\\"zlog_host\\\": \\\"192.168.0.3\\\", \\\"zlog_port\\\": 7340, \\\"log_paths\\\": {\\\"BLACS\\\": \\\"C:\\\\labscript_suite\\\\BLACS\\\\BLACS.log\\\"}}\"</code></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<p>The final process begins only upon connection to the <code>zprocess.remote</code> server by the blacs tab, and is not terminated when the two parent processes are (which is why shots can still run).</p>\n<p>Upon killing the rogue process:</p>\n<ol>\n<li>There\u2019s no indication in blacs that this has happened.</li>\n<li>Shots added to the queue fail to run, getting stuck in \u2018State: _transition_to_buffered (GUI)\u2019 and halting the queue indefinitely.</li>\n<li>Attempting to restart the tab while in this state results in similar observations to (3) above, except that the tab remains in the hung state after dismissing the <code>zprocess.utils.TimeoutError</code>.</li>\n<li>If instead of (2), the tab is attempted to be restarted (before any shots are added), the tab gets stuck in the following state indefinitely:</li>\n</ol>\n<p><img alt=\"\" src=\"data/bitbucket.org/repo/dR5qxr/images/1926582354-camera0.png\" />\n\u200c</p>\n<p>In any case, if the rogue process is killed and any of items (2)-(4) above are observed, blacs must be restarted entirely.</p>", "type": "rendered"}, "created_on": "2019-04-28T08:50:01.015384+00:00", "user": {"display_name": "Russell Anderson", "uuid": "{6c12ac6e-1980-466d-86fe-6c163bd116c2}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7B6c12ac6e-1980-466d-86fe-6c163bd116c2%7D"}, "html": {"href": "https://bitbucket.org/%7B6c12ac6e-1980-466d-86fe-6c163bd116c2%7D/"}, "avatar": {"href": "https://avatar-management--avatars.us-west-2.prod.public.atl-paas.net/557058:443e4cd1-86c9-4cd5-8034-22bab14d9d1e/e307ce36-5fb6-4418-8090-b9e533eab225/128"}}, "nickname": "rpanderson", "type": "user", "account_id": "557058:443e4cd1-86c9-4cd5-8034-22bab14d9d1e"}, "updated_on": "2019-04-28T11:44:19.395658+00:00", "type": "pullrequest_comment", "id": 100224954}