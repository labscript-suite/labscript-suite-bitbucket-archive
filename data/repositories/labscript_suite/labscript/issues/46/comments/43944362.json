{"links": {"self": {"href": "data/repositories/labscript_suite/labscript/issues/46/comments/43944362.json"}, "html": {"href": "#!/labscript_suite/labscript/issues/46#comment-43944362"}}, "issue": {"links": {"self": {"href": "data/repositories/labscript_suite/labscript/issues/46.json"}}, "type": "issue", "id": 46, "repository": {"links": {"self": {"href": "data/repositories/labscript_suite/labscript.json"}, "html": {"href": "#!/labscript_suite/labscript"}, "avatar": {"href": "data/bytebucket.org/ravatar/{48848b08-1db5-463b-bbdc-911beadf8bbf}ts=249917"}}, "type": "repository", "name": "labscript", "full_name": "labscript_suite/labscript", "uuid": "{48848b08-1db5-463b-bbdc-911beadf8bbf}"}, "title": "Ramps can over-/undershoot their final value"}, "content": {"raw": "So this is **not** an issue with the quantised times code. It actually happens before any of the code for quantised times runs. I'm pretty sure it's an issue with the floating point calculation error (to do with the time) inside the ramp function because. Specifically, if you set `t=1.806189632` you see the crash, but if you set `t=1.80618963` then you don't. All this does is offset the `initial` parameter in the ramp function (the duration stays the same which is the only argument used to evaluate the value at the end time point (so it's agnostic of the end time point). Similarly, using `t=1.8061896327` works fine but `t=1.8061896326` does not.\n\nInvestigating further, this error is due to the fact that we directly use the duration when parameterising the ramp (aka, when we create the `lambda function` in `labscript.functions.ramp`) but then use a calculated duration when evaluating the end point. The solution should be to instead use a duration internally in `AnalogQuantity.ramp` that is calculated as `t + truncation * duration -t`. In a terminal, this works for me and successfully returns `0.0` when you evaluate the function at the end point. However, in labscript I still see the crash (and the error is now twice the size it was before)....\n\nNot sure why that is, I'll keep digging!\n\nIn the meantime, a quick solution for you would be to just work out why you have 17 digits of precision in your time and quantise that away manually in your script.", "markup": "markdown", "html": "<p>So this is <strong>not</strong> an issue with the quantised times code. It actually happens before any of the code for quantised times runs. I'm pretty sure it's an issue with the floating point calculation error (to do with the time) inside the ramp function because. Specifically, if you set <code>t=1.806189632</code> you see the crash, but if you set <code>t=1.80618963</code> then you don't. All this does is offset the <code>initial</code> parameter in the ramp function (the duration stays the same which is the only argument used to evaluate the value at the end time point (so it's agnostic of the end time point). Similarly, using <code>t=1.8061896327</code> works fine but <code>t=1.8061896326</code> does not.</p>\n<p>Investigating further, this error is due to the fact that we directly use the duration when parameterising the ramp (aka, when we create the <code>lambda function</code> in <code>labscript.functions.ramp</code>) but then use a calculated duration when evaluating the end point. The solution should be to instead use a duration internally in <code>AnalogQuantity.ramp</code> that is calculated as <code>t + truncation * duration -t</code>. In a terminal, this works for me and successfully returns <code>0.0</code> when you evaluate the function at the end point. However, in labscript I still see the crash (and the error is now twice the size it was before)....</p>\n<p>Not sure why that is, I'll keep digging!</p>\n<p>In the meantime, a quick solution for you would be to just work out why you have 17 digits of precision in your time and quantise that away manually in your script.</p>", "type": "rendered"}, "created_on": "2018-03-15T22:54:05.666153+00:00", "user": {"display_name": "Philip Starkey", "uuid": "{48af65db-e5fc-459c-a7eb-52eb1f9a5690}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7B48af65db-e5fc-459c-a7eb-52eb1f9a5690%7D"}, "html": {"href": "https://bitbucket.org/%7B48af65db-e5fc-459c-a7eb-52eb1f9a5690%7D/"}, "avatar": {"href": "data/secure.gravatar.com/avatar/dc318537facc47ebe1ae98a7aabacecfd=httpsavatar-management--avatars.us-west-2.prod.public.atl-paas.netinitialsPS-0.png"}}, "nickname": "pstarkey", "type": "user", "account_id": "557058:52a111e4-40da-4441-9143-417f95f2db97"}, "updated_on": null, "type": "issue_comment", "id": 43944362}