{"links": {"self": {"href": "data/repositories/labscript_suite/labscript/pullrequests/11/comments/39168290.json"}, "html": {"href": "#!/labscript_suite/labscript/pull-requests/11/_/diff#comment-39168290"}}, "deleted": false, "pullrequest": {"type": "pullrequest", "id": 11, "links": {"self": {"href": "data/repositories/labscript_suite/labscript/pullrequests/11.json"}, "html": {"href": "#!/labscript_suite/labscript/pull-requests/11"}}, "title": "Added the ability to split ramps."}, "content": {"raw": "This unwanted behavior occures when the DigitalOut and the ramp are on different clocklines (digital clockline and analog clockline) on the same Pseudoclock. Without this fix labscript adds an additional clock tick on both clocklines at the DigitalOut's change time. It is possible that this additional tick on the analog clockline is too close to a ramp clock tick, so the physical card cannot handle the update rate and the digital Card is limited by the maximum clock\\_limit of the analog card during a ramp. If the clock\\_limit in the analog card is configured correctly, this will result in an LabscriptError.\n\nMy solution only adds a clock tick to the digital clockline and does not add an additional clock tick to the analog clockline, so the ramp is sampled with the appropriate samplerate which is configured in the ramp command.\n\n\u200c\n\nI wrote a demo script, which uses only devices that are implemented in the labscriptsuite (we use differnet ones). In out experiments we use higher sample rates, but the behavior is equivalent :\n\n`from labscript import *`\n\n`from labscript_devices.PulseBlaster_No_DDS import PulseBlaster_No_DDS`\n\n`from labscript_devices.NI_USB_6343 import NI_USB_6343`\n\n`from labscript_devices.NI_PCI_6733 import NI_PCI_6733`\n\n`#Connection Table`\n\n`PulseBlaster_No_DDS( name='pulse_blaster')`\n\n`ClockLine( name='A1_clockline', pseudoclock=pulse_blaster.pseudoclock, connection='flag 0')`\n\n`ClockLine( name='D1_clockline', pseudoclock=pulse_blaster.pseudoclock, connection='flag 2')`\n\n`DigitalOut( name='pb_flag4', parent_device=pulse_blaster.direct_outputs, connection='flag 4')`\n\n`NI_USB_6343(name=\"dio\", MAX_name=\"dummy\", parent_device=D1_clockline, clock_terminal=\"dummy\")`\n\n`DigitalOut( name='DO00', parent_device=dio, connection='port0/line0')`\n\n`NI_PCI_6733(name=\"ana\", MAX_name=\"dummy2\", parent_device=A1_clockline, clock_terminal=\"dummy2\")`\n\n`AnalogOut(name=\"AO0\", parent_device=ana, connection=\"ao0\")`\n\n`AnalogOut(name=\"AO1\", parent_device=ana, connection=\"ao1\")`\n\n`#Experiment Logic`\n\n`start()`\n\n`t=0.0`\n\n`AO0. ramp(t, duration=0.03, initial=3.0, final=5.0, samplerate=200)`\n\n`DO00. go_high(t+0.01555)`\n\n`t += 0.03`\n\n`t += 0.01`\n\n`stop(t)`\n\n\u200c\n\n\u200c\n\nThe corresponding runviewer output is:\n\n![old_version.png](https://bitbucket.org/repo/g75Ex9/images/2440920928-old_version.png 'old_version.png')\n\nThe output with my solution is:\n\n![new_version.png](https://bitbucket.org/repo/g75Ex9/images/1129694141-new_version.png 'new_version.png')\n\n\u200c\n\nI also removed the debug lines.", "markup": "markdown", "html": "<p>This unwanted behavior occures when the DigitalOut and the ramp are on different clocklines (digital clockline and analog clockline) on the same Pseudoclock. Without this fix labscript adds an additional clock tick on both clocklines at the DigitalOut's change time. It is possible that this additional tick on the analog clockline is too close to a ramp clock tick, so the physical card cannot handle the update rate and the digital Card is limited by the maximum clock_limit of the analog card during a ramp. If the clock_limit in the analog card is configured correctly, this will result in an LabscriptError.</p>\n<p>My solution only adds a clock tick to the digital clockline and does not add an additional clock tick to the analog clockline, so the ramp is sampled with the appropriate samplerate which is configured in the ramp command.</p>\n<p>\u200c</p>\n<p>I wrote a demo script, which uses only devices that are implemented in the labscriptsuite (we use differnet ones). In out experiments we use higher sample rates, but the behavior is equivalent :</p>\n<p><code>from labscript import *</code></p>\n<p><code>from labscript_devices.PulseBlaster_No_DDS import PulseBlaster_No_DDS</code></p>\n<p><code>from labscript_devices.NI_USB_6343 import NI_USB_6343</code></p>\n<p><code>from labscript_devices.NI_PCI_6733 import NI_PCI_6733</code></p>\n<p><code>#Connection Table</code></p>\n<p><code>PulseBlaster_No_DDS( name='pulse_blaster')</code></p>\n<p><code>ClockLine( name='A1_clockline', pseudoclock=pulse_blaster.pseudoclock, connection='flag 0')</code></p>\n<p><code>ClockLine( name='D1_clockline', pseudoclock=pulse_blaster.pseudoclock, connection='flag 2')</code></p>\n<p><code>DigitalOut( name='pb_flag4', parent_device=pulse_blaster.direct_outputs, connection='flag 4')</code></p>\n<p><code>NI_USB_6343(name=\"dio\", MAX_name=\"dummy\", parent_device=D1_clockline, clock_terminal=\"dummy\")</code></p>\n<p><code>DigitalOut( name='DO00', parent_device=dio, connection='port0/line0')</code></p>\n<p><code>NI_PCI_6733(name=\"ana\", MAX_name=\"dummy2\", parent_device=A1_clockline, clock_terminal=\"dummy2\")</code></p>\n<p><code>AnalogOut(name=\"AO0\", parent_device=ana, connection=\"ao0\")</code></p>\n<p><code>AnalogOut(name=\"AO1\", parent_device=ana, connection=\"ao1\")</code></p>\n<p><code>#Experiment Logic</code></p>\n<p><code>start()</code></p>\n<p><code>t=0.0</code></p>\n<p><code>AO0. ramp(t, duration=0.03, initial=3.0, final=5.0, samplerate=200)</code></p>\n<p><code>DO00. go_high(t+0.01555)</code></p>\n<p><code>t += 0.03</code></p>\n<p><code>t += 0.01</code></p>\n<p><code>stop(t)</code></p>\n<p>\u200c</p>\n<p>\u200c</p>\n<p>The corresponding runviewer output is:</p>\n<p><img alt=\"old_version.png\" src=\"data/bitbucket.org/repo/g75Ex9/images/2440920928-old_version.png\" title=\"old_version.png\" /></p>\n<p>The output with my solution is:</p>\n<p><img alt=\"new_version.png\" src=\"data/bitbucket.org/repo/g75Ex9/images/1129694141-new_version.png\" title=\"new_version.png\" /></p>\n<p>\u200c</p>\n<p>I also removed the debug lines.</p>", "type": "rendered"}, "created_on": "2017-06-20T11:44:10.142198+00:00", "user": {"display_name": "ReneKolb", "uuid": "{a14da38a-5a42-4215-a657-8d03e2e12c62}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7Ba14da38a-5a42-4215-a657-8d03e2e12c62%7D"}, "html": {"href": "https://bitbucket.org/%7Ba14da38a-5a42-4215-a657-8d03e2e12c62%7D/"}, "avatar": {"href": "data/secure.gravatar.com/avatar/fdb60d6ad1bfc79b620af131e1ff76acd=httpsavatar-management--avatars.us-west-2.prod.public.atl-paas.netinitialsR-3.png"}}, "nickname": "ReneKolb", "type": "user", "account_id": "557058:cee66bea-c1f2-4230-9ace-11e2dc725285"}, "updated_on": "2017-06-20T11:55:32.654068+00:00", "type": "pullrequest_comment", "id": 39168290}