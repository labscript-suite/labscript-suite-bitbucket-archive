{"priority": "major", "kind": "bug", "repository": {"links": {"self": {"href": "data/repositories/labscript_suite/labscript_devices.json"}, "html": {"href": "#!/labscript_suite/labscript_devices"}, "avatar": {"href": "data/bytebucket.org/ravatar/{30c94cb1-feec-4534-8885-92452023c9c9}ts=python"}}, "type": "repository", "name": "labscript_devices", "full_name": "labscript_suite/labscript_devices", "uuid": "{30c94cb1-feec-4534-8885-92452023c9c9}"}, "links": {"attachments": {"href": "data/repositories/labscript_suite/labscript_devices/issues/33/attachments_page=1.json"}, "self": {"href": "data/repositories/labscript_suite/labscript_devices/issues/33.json"}, "watch": {"href": "https://api.bitbucket.org/2.0/repositories/labscript_suite/labscript_devices/issues/33/watch"}, "comments": {"href": "data/repositories/labscript_suite/labscript_devices/issues/33/comments_page=1.json"}, "html": {"href": "#!/labscript_suite/labscript_devices/issues/33/setting-pulseblaster-pulse_width-has"}, "vote": {"href": "https://api.bitbucket.org/2.0/repositories/labscript_suite/labscript_devices/issues/33/vote"}}, "reporter": {"display_name": "Chris Billington", "uuid": "{e363c5a9-5075-4656-afb5-88bd6a6dceeb}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7Be363c5a9-5075-4656-afb5-88bd6a6dceeb%7D"}, "html": {"href": "https://bitbucket.org/%7Be363c5a9-5075-4656-afb5-88bd6a6dceeb%7D/"}, "avatar": {"href": "data/secure.gravatar.com/avatar/9238baf7300c41c0e7294db922899e6ad=httpsavatar-management--avatars.us-west-2.prod.public.atl-paas.netinitialsCB-1.png"}}, "nickname": "cbillington", "type": "user", "account_id": "557058:cbf1bc43-1dc2-477b-9e25-1a8f40fd7ee3"}, "title": "Setting pulseblaster pulse_width has incorrect results; spurious error.", "component": null, "votes": 0, "watches": 2, "content": {"raw": "If the PulseBlaster's `pulse_width` keyword argument is used, the shot ends up being approximately twice as long as it should be:\r\n\r\n```python\r\nfrom labscript import start, stop, ClockLine, labscript_init\r\nfrom labscript_devices.PulseBlaster import PulseBlaster\r\n\r\nlabscript_init('test.h5', new=True, overwrite=True)\r\nPulseBlaster('pulseblaster', pulse_width=1e-6)\r\nClockLine('clockline', pseudoclock=pulseblaster.pseudoclock, connection='flag 0')\r\n\r\n\r\nstart()\r\nstop(3)\r\n\r\nimport h5py\r\nwith h5py.File('test.h5') as f:\r\n    duration = f['devices/pulseblaster/PULSE_PROGRAM']['length'].sum() / 1e9\r\n    print(duration)\r\n```\r\n\r\nThis prints `6.000053678714858` as the total duration of PulseBlaster instructions, although the requested stop time was 3 seconds.\r\n\r\nThis is a regression introduced by 33d843a057e1. If I backout that changeset, the above prints the more expected value `3.0000429429718882`.\r\n\r\nBacking out the changeset had a minor merge conflict. It was trivial, but for what it's worth [here](#!/cbillington/labscript_devices/commits/729c72a6692b3a45021a05255fc4b528f481aa2a) is a commit that backs it out, if you want to see the diff without all the noise of what happened in between then and now.\r\n\r\nThere is also a spurious error raised if there is a single segment of the experiment in which no non-external clocks tick. The error is clearly intended to prevent you using pulse_width when there are *no* external clocks in use, but it is being tested on a per-instruction basis. It almost looks like the error checking can be removed with no consequence.\r\n\r\n```python\r\nfrom labscript import start, stop, ClockLine, labscript_init, DigitalOut, DDS\r\nfrom labscript_devices.PulseBlaster import PulseBlaster\r\nfrom labscript_devices.NovaTechDDS9M import NovaTechDDS9M\r\n\r\nlabscript_init('test.h5', new=True, overwrite=True)\r\nPulseBlaster('pulseblaster', pulse_width=1e-6)\r\nClockLine('clockline', pseudoclock=pulseblaster.pseudoclock, connection='flag 0')\r\nNovaTechDDS9M('novatech', parent_device=clockline)\r\nDDS('NTDDS', parent_device=novatech, connection='channel 1')\r\nDigitalOut('DO', parent_device=pulseblaster.direct_outputs, connection='flag 1')\r\n\r\nstart()\r\n\r\nDO.go_high(0.1)\r\nNTDDS.setamp(0.2, 1.0)\r\n\r\nstop(3)\r\n```\r\n```python\r\nTraceback (most recent call last):\r\n  File \"261.py\", line 17, in <module>\r\n    stop(3)\r\n  File \"/home/bilbo/labscript_suite/labscript/labscript.py\", line 2337, in stop\r\n    generate_code()\r\n  File \"/home/bilbo/labscript_suite/labscript/labscript.py\", line 2213, in generate_code\r\n    device.generate_code(hdf5_file)\r\n  File \"/home/bilbo/labscript_suite/labscript_devices/PulseBlaster.py\", line 579, in generate_code\r\n    pb_inst = self.convert_to_pb_inst(dig_outputs, dds_outputs, freqs, amps, phases)\r\n  File \"/home/bilbo/labscript_suite/labscript_devices/PulseBlaster.py\", line 405, in convert_to_pb_inst\r\n    raise LabscriptError('You cannot set a pulse_width for %s (%s) if it is not used as a pseudoclock for another device'%(self.name, self.description))\r\nlabscript.labscript.LabscriptError: You cannot set a pulse_width for pulseblaster (PB-DDSII-300) if it is not used as a pseudoclock for another device\r\n```", "markup": "markdown", "html": "<p>If the PulseBlaster's <code>pulse_width</code> keyword argument is used, the shot ends up being approximately twice as long as it should be:</p>\n<div class=\"codehilite language-python\"><pre><span></span><span class=\"kn\">from</span> <span class=\"nn\">labscript</span> <span class=\"kn\">import</span> <span class=\"n\">start</span><span class=\"p\">,</span> <span class=\"n\">stop</span><span class=\"p\">,</span> <span class=\"n\">ClockLine</span><span class=\"p\">,</span> <span class=\"n\">labscript_init</span>\n<span class=\"kn\">from</span> <span class=\"nn\">labscript_devices.PulseBlaster</span> <span class=\"kn\">import</span> <span class=\"n\">PulseBlaster</span>\n\n<span class=\"n\">labscript_init</span><span class=\"p\">(</span><span class=\"s1\">&#39;test.h5&#39;</span><span class=\"p\">,</span> <span class=\"n\">new</span><span class=\"o\">=</span><span class=\"bp\">True</span><span class=\"p\">,</span> <span class=\"n\">overwrite</span><span class=\"o\">=</span><span class=\"bp\">True</span><span class=\"p\">)</span>\n<span class=\"n\">PulseBlaster</span><span class=\"p\">(</span><span class=\"s1\">&#39;pulseblaster&#39;</span><span class=\"p\">,</span> <span class=\"n\">pulse_width</span><span class=\"o\">=</span><span class=\"mf\">1e-6</span><span class=\"p\">)</span>\n<span class=\"n\">ClockLine</span><span class=\"p\">(</span><span class=\"s1\">&#39;clockline&#39;</span><span class=\"p\">,</span> <span class=\"n\">pseudoclock</span><span class=\"o\">=</span><span class=\"n\">pulseblaster</span><span class=\"o\">.</span><span class=\"n\">pseudoclock</span><span class=\"p\">,</span> <span class=\"n\">connection</span><span class=\"o\">=</span><span class=\"s1\">&#39;flag 0&#39;</span><span class=\"p\">)</span>\n\n\n<span class=\"n\">start</span><span class=\"p\">()</span>\n<span class=\"n\">stop</span><span class=\"p\">(</span><span class=\"mi\">3</span><span class=\"p\">)</span>\n\n<span class=\"kn\">import</span> <span class=\"nn\">h5py</span>\n<span class=\"k\">with</span> <span class=\"n\">h5py</span><span class=\"o\">.</span><span class=\"n\">File</span><span class=\"p\">(</span><span class=\"s1\">&#39;test.h5&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n    <span class=\"n\">duration</span> <span class=\"o\">=</span> <span class=\"n\">f</span><span class=\"p\">[</span><span class=\"s1\">&#39;devices/pulseblaster/PULSE_PROGRAM&#39;</span><span class=\"p\">][</span><span class=\"s1\">&#39;length&#39;</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">sum</span><span class=\"p\">()</span> <span class=\"o\">/</span> <span class=\"mf\">1e9</span>\n    <span class=\"k\">print</span><span class=\"p\">(</span><span class=\"n\">duration</span><span class=\"p\">)</span>\n</pre></div>\n\n\n<p>This prints <code>6.000053678714858</code> as the total duration of PulseBlaster instructions, although the requested stop time was 3 seconds.</p>\n<p>This is a regression introduced by <a href=\"#!/labscript_suite/labscript_devices/commits/33d843a057e1\" rel=\"nofollow\" class=\"ap-connect-link\">33d843a057e1</a>. If I backout that changeset, the above prints the more expected value <code>3.0000429429718882</code>.</p>\n<p>Backing out the changeset had a minor merge conflict. It was trivial, but for what it's worth <a data-is-external-link=\"true\" href=\"#!/cbillington/labscript_devices/commits/729c72a6692b3a45021a05255fc4b528f481aa2a\" rel=\"nofollow\">here</a> is a commit that backs it out, if you want to see the diff without all the noise of what happened in between then and now.</p>\n<p>There is also a spurious error raised if there is a single segment of the experiment in which no non-external clocks tick. The error is clearly intended to prevent you using pulse_width when there are <em>no</em> external clocks in use, but it is being tested on a per-instruction basis. It almost looks like the error checking can be removed with no consequence.</p>\n<div class=\"codehilite language-python\"><pre><span></span><span class=\"kn\">from</span> <span class=\"nn\">labscript</span> <span class=\"kn\">import</span> <span class=\"n\">start</span><span class=\"p\">,</span> <span class=\"n\">stop</span><span class=\"p\">,</span> <span class=\"n\">ClockLine</span><span class=\"p\">,</span> <span class=\"n\">labscript_init</span><span class=\"p\">,</span> <span class=\"n\">DigitalOut</span><span class=\"p\">,</span> <span class=\"n\">DDS</span>\n<span class=\"kn\">from</span> <span class=\"nn\">labscript_devices.PulseBlaster</span> <span class=\"kn\">import</span> <span class=\"n\">PulseBlaster</span>\n<span class=\"kn\">from</span> <span class=\"nn\">labscript_devices.NovaTechDDS9M</span> <span class=\"kn\">import</span> <span class=\"n\">NovaTechDDS9M</span>\n\n<span class=\"n\">labscript_init</span><span class=\"p\">(</span><span class=\"s1\">&#39;test.h5&#39;</span><span class=\"p\">,</span> <span class=\"n\">new</span><span class=\"o\">=</span><span class=\"bp\">True</span><span class=\"p\">,</span> <span class=\"n\">overwrite</span><span class=\"o\">=</span><span class=\"bp\">True</span><span class=\"p\">)</span>\n<span class=\"n\">PulseBlaster</span><span class=\"p\">(</span><span class=\"s1\">&#39;pulseblaster&#39;</span><span class=\"p\">,</span> <span class=\"n\">pulse_width</span><span class=\"o\">=</span><span class=\"mf\">1e-6</span><span class=\"p\">)</span>\n<span class=\"n\">ClockLine</span><span class=\"p\">(</span><span class=\"s1\">&#39;clockline&#39;</span><span class=\"p\">,</span> <span class=\"n\">pseudoclock</span><span class=\"o\">=</span><span class=\"n\">pulseblaster</span><span class=\"o\">.</span><span class=\"n\">pseudoclock</span><span class=\"p\">,</span> <span class=\"n\">connection</span><span class=\"o\">=</span><span class=\"s1\">&#39;flag 0&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">NovaTechDDS9M</span><span class=\"p\">(</span><span class=\"s1\">&#39;novatech&#39;</span><span class=\"p\">,</span> <span class=\"n\">parent_device</span><span class=\"o\">=</span><span class=\"n\">clockline</span><span class=\"p\">)</span>\n<span class=\"n\">DDS</span><span class=\"p\">(</span><span class=\"s1\">&#39;NTDDS&#39;</span><span class=\"p\">,</span> <span class=\"n\">parent_device</span><span class=\"o\">=</span><span class=\"n\">novatech</span><span class=\"p\">,</span> <span class=\"n\">connection</span><span class=\"o\">=</span><span class=\"s1\">&#39;channel 1&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">DigitalOut</span><span class=\"p\">(</span><span class=\"s1\">&#39;DO&#39;</span><span class=\"p\">,</span> <span class=\"n\">parent_device</span><span class=\"o\">=</span><span class=\"n\">pulseblaster</span><span class=\"o\">.</span><span class=\"n\">direct_outputs</span><span class=\"p\">,</span> <span class=\"n\">connection</span><span class=\"o\">=</span><span class=\"s1\">&#39;flag 1&#39;</span><span class=\"p\">)</span>\n\n<span class=\"n\">start</span><span class=\"p\">()</span>\n\n<span class=\"n\">DO</span><span class=\"o\">.</span><span class=\"n\">go_high</span><span class=\"p\">(</span><span class=\"mf\">0.1</span><span class=\"p\">)</span>\n<span class=\"n\">NTDDS</span><span class=\"o\">.</span><span class=\"n\">setamp</span><span class=\"p\">(</span><span class=\"mf\">0.2</span><span class=\"p\">,</span> <span class=\"mf\">1.0</span><span class=\"p\">)</span>\n\n<span class=\"n\">stop</span><span class=\"p\">(</span><span class=\"mi\">3</span><span class=\"p\">)</span>\n</pre></div>\n\n\n<div class=\"codehilite language-python\"><pre><span></span><span class=\"n\">Traceback</span> <span class=\"p\">(</span><span class=\"n\">most</span> <span class=\"n\">recent</span> <span class=\"n\">call</span> <span class=\"n\">last</span><span class=\"p\">):</span>\n  <span class=\"n\">File</span> <span class=\"s2\">&quot;261.py&quot;</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">17</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"o\">&lt;</span><span class=\"n\">module</span><span class=\"o\">&gt;</span>\n    <span class=\"n\">stop</span><span class=\"p\">(</span><span class=\"mi\">3</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">&quot;/home/bilbo/labscript_suite/labscript/labscript.py&quot;</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">2337</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">stop</span>\n    <span class=\"n\">generate_code</span><span class=\"p\">()</span>\n  <span class=\"n\">File</span> <span class=\"s2\">&quot;/home/bilbo/labscript_suite/labscript/labscript.py&quot;</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">2213</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">generate_code</span>\n    <span class=\"n\">device</span><span class=\"o\">.</span><span class=\"n\">generate_code</span><span class=\"p\">(</span><span class=\"n\">hdf5_file</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">&quot;/home/bilbo/labscript_suite/labscript_devices/PulseBlaster.py&quot;</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">579</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">generate_code</span>\n    <span class=\"n\">pb_inst</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">convert_to_pb_inst</span><span class=\"p\">(</span><span class=\"n\">dig_outputs</span><span class=\"p\">,</span> <span class=\"n\">dds_outputs</span><span class=\"p\">,</span> <span class=\"n\">freqs</span><span class=\"p\">,</span> <span class=\"n\">amps</span><span class=\"p\">,</span> <span class=\"n\">phases</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">&quot;/home/bilbo/labscript_suite/labscript_devices/PulseBlaster.py&quot;</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">405</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">convert_to_pb_inst</span>\n    <span class=\"k\">raise</span> <span class=\"n\">LabscriptError</span><span class=\"p\">(</span><span class=\"s1\">&#39;You cannot set a pulse_width for </span><span class=\"si\">%s</span><span class=\"s1\"> (</span><span class=\"si\">%s</span><span class=\"s1\">) if it is not used as a pseudoclock for another device&#39;</span><span class=\"o\">%</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">description</span><span class=\"p\">))</span>\n<span class=\"n\">labscript</span><span class=\"o\">.</span><span class=\"n\">labscript</span><span class=\"o\">.</span><span class=\"n\">LabscriptError</span><span class=\"p\">:</span> <span class=\"n\">You</span> <span class=\"n\">cannot</span> <span class=\"nb\">set</span> <span class=\"n\">a</span> <span class=\"n\">pulse_width</span> <span class=\"k\">for</span> <span class=\"n\">pulseblaster</span> <span class=\"p\">(</span><span class=\"n\">PB</span><span class=\"o\">-</span><span class=\"n\">DDSII</span><span class=\"o\">-</span><span class=\"mi\">300</span><span class=\"p\">)</span> <span class=\"k\">if</span> <span class=\"n\">it</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"n\">used</span> <span class=\"k\">as</span> <span class=\"n\">a</span> <span class=\"n\">pseudoclock</span> <span class=\"k\">for</span> <span class=\"n\">another</span> <span class=\"n\">device</span>\n</pre></div>", "type": "rendered"}, "assignee": {"display_name": "Chris Billington", "uuid": "{e363c5a9-5075-4656-afb5-88bd6a6dceeb}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7Be363c5a9-5075-4656-afb5-88bd6a6dceeb%7D"}, "html": {"href": "https://bitbucket.org/%7Be363c5a9-5075-4656-afb5-88bd6a6dceeb%7D/"}, "avatar": {"href": "data/secure.gravatar.com/avatar/9238baf7300c41c0e7294db922899e6ad=httpsavatar-management--avatars.us-west-2.prod.public.atl-paas.netinitialsCB-1.png"}}, "nickname": "cbillington", "type": "user", "account_id": "557058:cbf1bc43-1dc2-477b-9e25-1a8f40fd7ee3"}, "state": "resolved", "version": null, "edited_on": null, "created_on": "2019-05-14T20:36:54.582969+00:00", "milestone": null, "updated_on": "2019-06-01T16:36:22.223683+00:00", "type": "issue", "id": 33}