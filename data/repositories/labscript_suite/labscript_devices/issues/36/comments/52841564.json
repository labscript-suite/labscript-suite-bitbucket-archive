{"links": {"self": {"href": "data/repositories/labscript_suite/labscript_devices/issues/36/comments/52841564.json"}, "html": {"href": "#!/labscript_suite/labscript_devices/issues/36#comment-52841564"}}, "issue": {"links": {"self": {"href": "data/repositories/labscript_suite/labscript_devices/issues/36.json"}}, "type": "issue", "id": 36, "repository": {"links": {"self": {"href": "data/repositories/labscript_suite/labscript_devices.json"}, "html": {"href": "#!/labscript_suite/labscript_devices"}, "avatar": {"href": "data/bytebucket.org/ravatar/{30c94cb1-feec-4534-8885-92452023c9c9}ts=python"}}, "type": "repository", "name": "labscript_devices", "full_name": "labscript_suite/labscript_devices", "uuid": "{30c94cb1-feec-4534-8885-92452023c9c9}"}, "title": "BLACS hang with continuous camera acquisitions"}, "content": {"raw": "I was not able to reproduce this, with frame rates close to 180fps. I'll try again on a different computer later.\n\nHowever, I did find a deadlock if one clicks 'restart' for the tab while acquiring at high frame rates. So I have fixed that (PR #77). It doesn't seem like the same issue though, even though this one sounds like a deadlock of some sort too.\n\nIf you are able to reliably reproduce the problem, then I can tell you what I would be doing if I could reproduce it, and maybe you can show me the resulting tracebacks and we might be able to figure out what's going on.\n\nI would add at the top of `blacs/__main__.py`:\n\n```python\nimport faulthandler\nf = open(r'C:\\labscript_suite\\blacs\\faulthandler.log', 'a')\nf.write('\\n\\n---restart---\\n\\n')\nfaulthandler.dump_traceback_later(timeout=60, repeat=True, file=f)\n```\n\nThen, once the hang occurs, wait a full 60 seconds (or wait less if you decrease the timeout for dumping tracebacks), then quit BLACS. I don't know if it will flush the output file. If it doesn't and Python exits in an unclean way, the output file may not contain the final set of tracebacks. In which case I would switch it to `file=sys.stderr` and rely on reading it from the terminal, but you may need to increase the number of scrollback lines in the terminal settings, otherwise you won't be able to see all the tracebacks - it outputs one traceback per thread, and there are likely to be tens of threads, depending on how many devices you have.", "markup": "markdown", "html": "<p>I was not able to reproduce this, with frame rates close to 180fps. I'll try again on a different computer later.</p>\n<p>However, I did find a deadlock if one clicks 'restart' for the tab while acquiring at high frame rates. So I have fixed that (<a href=\"#!/labscript_suite/labscript_devices/pull-requests/77/fix-a-deadlock-restarting-imaqdxcamera\" rel=\"nofollow\" class=\"ap-connect-link\">PR #77</a>). It doesn't seem like the same issue though, even though this one sounds like a deadlock of some sort too.</p>\n<p>If you are able to reliably reproduce the problem, then I can tell you what I would be doing if I could reproduce it, and maybe you can show me the resulting tracebacks and we might be able to figure out what's going on.</p>\n<p>I would add at the top of <code>blacs/__main__.py</code>:</p>\n<div class=\"codehilite language-python\"><pre><span></span><span class=\"kn\">import</span> <span class=\"nn\">faulthandler</span>\n<span class=\"n\">f</span> <span class=\"o\">=</span> <span class=\"nb\">open</span><span class=\"p\">(</span><span class=\"sa\">r</span><span class=\"s1\">&#39;C:\\labscript_suite\\blacs\\faulthandler.log&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;a&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span><span class=\"p\">(</span><span class=\"s1\">&#39;</span><span class=\"se\">\\n\\n</span><span class=\"s1\">---restart---</span><span class=\"se\">\\n\\n</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">faulthandler</span><span class=\"o\">.</span><span class=\"n\">dump_traceback_later</span><span class=\"p\">(</span><span class=\"n\">timeout</span><span class=\"o\">=</span><span class=\"mi\">60</span><span class=\"p\">,</span> <span class=\"n\">repeat</span><span class=\"o\">=</span><span class=\"bp\">True</span><span class=\"p\">,</span> <span class=\"nb\">file</span><span class=\"o\">=</span><span class=\"n\">f</span><span class=\"p\">)</span>\n</pre></div>\n\n\n<p>Then, once the hang occurs, wait a full 60 seconds (or wait less if you decrease the timeout for dumping tracebacks), then quit BLACS. I don't know if it will flush the output file. If it doesn't and Python exits in an unclean way, the output file may not contain the final set of tracebacks. In which case I would switch it to <code>file=sys.stderr</code> and rely on reading it from the terminal, but you may need to increase the number of scrollback lines in the terminal settings, otherwise you won't be able to see all the tracebacks - it outputs one traceback per thread, and there are likely to be tens of threads, depending on how many devices you have.</p>", "type": "rendered"}, "created_on": "2019-07-03T20:48:03.284960+00:00", "user": {"display_name": "Chris Billington", "uuid": "{e363c5a9-5075-4656-afb5-88bd6a6dceeb}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7Be363c5a9-5075-4656-afb5-88bd6a6dceeb%7D"}, "html": {"href": "https://bitbucket.org/%7Be363c5a9-5075-4656-afb5-88bd6a6dceeb%7D/"}, "avatar": {"href": "data/secure.gravatar.com/avatar/9238baf7300c41c0e7294db922899e6ad=httpsavatar-management--avatars.us-west-2.prod.public.atl-paas.netinitialsCB-1.png"}}, "nickname": "cbillington", "type": "user", "account_id": "557058:cbf1bc43-1dc2-477b-9e25-1a8f40fd7ee3"}, "updated_on": "2019-07-03T20:48:47.897866+00:00", "type": "issue_comment", "id": 52841564}