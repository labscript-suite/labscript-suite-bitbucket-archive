{"links": {"self": {"href": "data/repositories/labscript_suite/labscript_devices/pullrequests/56/comments/95836681.json"}, "html": {"href": "#!/labscript_suite/labscript_devices/pull-requests/56/_/diff#comment-95836681"}}, "deleted": false, "pullrequest": {"type": "pullrequest", "id": 56, "links": {"self": {"href": "data/repositories/labscript_suite/labscript_devices/pullrequests/56.json"}, "html": {"href": "#!/labscript_suite/labscript_devices/pull-requests/56"}}, "title": "Universal NI DAQmx support"}, "content": {"raw": "The last update works fine for us for PCI\\_6713 and PCI\\_6251. NI\\_6534 has a problem when seting up the DO channels.\n\nThe error message is the following:  \n\n```\nException in worker - Thu Mar 21, 09:11:56 :\r\nTraceback (most recent call last):\r\n  File \"C:\\labscript_suite\\labscript_devices\\NI_DAQmx\\blacs_workers.py\", line 55, in init\r\n    self.start_manual_mode_tasks()\r\n  File \"C:\\labscript_suite\\labscript_devices\\NI_DAQmx\\blacs_workers.py\", line 114, in start_manual_mode_tasks\r\n    self.DO_task.StartTask()\r\n  File \"<string>\", line 3, in StartTask\r\n  File \"<string>\", line 2, in function\r\n  File \"C:\\ProgramData\\Anaconda3\\lib\\site-packages\\PyDAQmx\\DAQmxFunctions.py\", line 62, in mafunction\r\n    raise exception_class(errBuff.value.decode(\"utf-8\"), f.__name__)\r\nPyDAQmx.DAQmxFunctions.InvalidChannelError: Channel is not in the task, and the channel is not a valid global channel.\r\n\r\nMake sure that the channel is in the task or that the channel is a valid global channel. If you explicitly named the virtual channel in DAQmx Create Channel, you must use the name assigned to that channel. Also, check for typing errors.\r\nTask Name: _unnamedTask<0>\r\n\r\nStatus Code: -200087\r\n in function DAQmxStartTask\n```\n\nI had a look in our current NI\\_DAQmx class from @PhyNerd and he initialised the DO\\_channels like this:\n\n```\n# TODO: Currently labscript only supports one DO port, easy to add more\r\n        # by passing a suitable structure of DO ports\r\n        # I verified above that num['num_DO'] is a factor of 8\r\n        for i in range(self.num['num_ports_DO']):\r\n            for j in range(self.num['num_DO']//self.num['num_ports_DO']//8):\r\n                self.do_task.CreateDOChan(self.MAX_name+\"/port%d/line%d:%d\"%(i, 8*j, 8*j+7),\"\", DAQmx_Val_ChanForAllLines)\r\n\r\n        # currently do not allow direct access to PFI ports.  In the future can refer to NU_USB6346 code for an example\n```\n\nAs we pass in our NI\\_DAQmx class the number of DO ports by hand \\(num\\_DO\\_ports =4\\) and we encountered yesterday that automatically 6 ports are found I thought that this is maybe causing the problem, so I removed the two extra ports in the model-file but this did not change anything. I suspect this is because the port settings are stored somewhere else aswell as before and after the change blacs shows 5 ports in the tab \\(port 0-3 and port 5\\).", "markup": "markdown", "html": "<p>The last update works fine for us for PCI_6713 and PCI_6251. NI_6534 has a problem when seting up the DO channels.</p>\n<p>The error message is the following:  </p>\n<div class=\"codehilite\"><pre><span></span>Exception in worker - Thu Mar 21, 09:11:56 :\nTraceback (most recent call last):\n  File &quot;C:\\labscript_suite\\labscript_devices\\NI_DAQmx\\blacs_workers.py&quot;, line 55, in init\n    self.start_manual_mode_tasks()\n  File &quot;C:\\labscript_suite\\labscript_devices\\NI_DAQmx\\blacs_workers.py&quot;, line 114, in start_manual_mode_tasks\n    self.DO_task.StartTask()\n  File &quot;&lt;string&gt;&quot;, line 3, in StartTask\n  File &quot;&lt;string&gt;&quot;, line 2, in function\n  File &quot;C:\\ProgramData\\Anaconda3\\lib\\site-packages\\PyDAQmx\\DAQmxFunctions.py&quot;, line 62, in mafunction\n    raise exception_class(errBuff.value.decode(&quot;utf-8&quot;), f.__name__)\nPyDAQmx.DAQmxFunctions.InvalidChannelError: Channel is not in the task, and the channel is not a valid global channel.\n\nMake sure that the channel is in the task or that the channel is a valid global channel. If you explicitly named the virtual channel in DAQmx Create Channel, you must use the name assigned to that channel. Also, check for typing errors.\nTask Name: _unnamedTask&lt;0&gt;\n\nStatus Code: -200087\n in function DAQmxStartTask\n</pre></div>\n\n\n<p>I had a look in our current NI_DAQmx class from @PhyNerd and he initialised the DO_channels like this:</p>\n<div class=\"codehilite\"><pre><span></span># TODO: Currently labscript only supports one DO port, easy to add more\n        # by passing a suitable structure of DO ports\n        # I verified above that num[&#39;num_DO&#39;] is a factor of 8\n        for i in range(self.num[&#39;num_ports_DO&#39;]):\n            for j in range(self.num[&#39;num_DO&#39;]//self.num[&#39;num_ports_DO&#39;]//8):\n                self.do_task.CreateDOChan(self.MAX_name+&quot;/port%d/line%d:%d&quot;%(i, 8*j, 8*j+7),&quot;&quot;, DAQmx_Val_ChanForAllLines)\n\n        # currently do not allow direct access to PFI ports.  In the future can refer to NU_USB6346 code for an example\n</pre></div>\n\n\n<p>As we pass in our NI_DAQmx class the number of DO ports by hand (num_DO_ports =4) and we encountered yesterday that automatically 6 ports are found I thought that this is maybe causing the problem, so I removed the two extra ports in the model-file but this did not change anything. I suspect this is because the port settings are stored somewhere else aswell as before and after the change blacs shows 5 ports in the tab (port 0-3 and port 5).</p>", "type": "rendered"}, "created_on": "2019-03-21T08:28:18.508414+00:00", "user": {"display_name": "Lars Kohfahl", "uuid": "{14b59397-cbc0-4d8c-8a4a-fe99fb4d2d4a}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7B14b59397-cbc0-4d8c-8a4a-fe99fb4d2d4a%7D"}, "html": {"href": "https://bitbucket.org/%7B14b59397-cbc0-4d8c-8a4a-fe99fb4d2d4a%7D/"}, "avatar": {"href": "data/secure.gravatar.com/avatar/630642264cd55e22515678a3a0489ac7d=httpsavatar-management--avatars.us-west-2.prod.public.atl-paas.netinitialsLK-2.png"}}, "nickname": "lkohfahl", "type": "user", "account_id": "5aafc5d11396802a57aa7f3b"}, "updated_on": "2019-03-21T08:28:18.679358+00:00", "type": "pullrequest_comment", "id": 95836681}