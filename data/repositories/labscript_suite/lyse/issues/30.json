{"priority": "minor", "kind": "task", "repository": {"links": {"self": {"href": "data/repositories/labscript_suite/lyse.json"}, "html": {"href": "#!/labscript_suite/lyse"}, "avatar": {"href": "data/bytebucket.org/ravatar/{55eebdfe-43d1-4ae8-9049-50c55b295397}ts=249921"}}, "type": "repository", "name": "lyse", "full_name": "labscript_suite/lyse", "uuid": "{55eebdfe-43d1-4ae8-9049-50c55b295397}"}, "links": {"attachments": {"href": "data/repositories/labscript_suite/lyse/issues/30/attachments_page=1.json"}, "self": {"href": "data/repositories/labscript_suite/lyse/issues/30.json"}, "watch": {"href": "https://api.bitbucket.org/2.0/repositories/labscript_suite/lyse/issues/30/watch"}, "comments": {"href": "data/repositories/labscript_suite/lyse/issues/30/comments_page=1.json"}, "html": {"href": "#!/labscript_suite/lyse/issues/30/python-3"}, "vote": {"href": "https://api.bitbucket.org/2.0/repositories/labscript_suite/lyse/issues/30/vote"}}, "reporter": {"display_name": "Jan Werkmann", "uuid": "{44c4905c-2b90-4045-a5f1-652b8e228626}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7B44c4905c-2b90-4045-a5f1-652b8e228626%7D"}, "html": {"href": "https://bitbucket.org/%7B44c4905c-2b90-4045-a5f1-652b8e228626%7D/"}, "avatar": {"href": "https://avatar-management--avatars.us-west-2.prod.public.atl-paas.net/557058:a70cc9cf-684e-4849-a61a-9ade4d7218b5/07e5095a-4741-4dc0-a462-9c7d455f961d/128"}}, "nickname": "PhyNerd", "type": "user", "account_id": "557058:a70cc9cf-684e-4849-a61a-9ade4d7218b5"}, "title": "Python 3", "component": null, "votes": 0, "watches": 1, "content": {"raw": "As Python 3 porting is not that far away I would like to collect python 3 incompatibilities here.\r\nAnd also collect fixes so they can be discussed and I don't lose them somewhere in my repos.\r\nSo far besides the obvious lack of PyQt5 and unicode I found the following problems:\r\n\r\n* the module Queue is names queue in python 3 so in \\_\\_main\\_\\_.py we should to this:\r\n```\r\n#!python\r\nif six.PY2:\r\n    import Queue\r\nelse:\r\n    import queue as Queue\r\n```\r\n* in \\_\\_main\\_\\_.py  there exists a line:\r\n\r\n```\r\n#!python\r\n\r\nfor column_index, name in sorted(column_names.items(), key=lambda s: s[1]):\r\n```\r\nwhich throws the exception:\r\n\r\n```\r\n#!python\r\n\r\n  File \"lyse/__main__.py\", line 844, in populate_model\r\n    for column_index, name in sorted(column_names.items(), key=lambda s: s[1]):\r\nTypeError: '<' not supported between instances of 'tuple' and 'str'\r\n```\r\nA fix for this is:\r\n\r\n```\r\n#!python\r\n\r\n        def get_key(s):\r\n            while isinstance(s, tuple):\r\n                s = s[1]\r\n            return s\r\n\r\n        for column_index, name in sorted(column_names.items(), key=get_key):\r\n```\r\n* in  \\_\\_init\\_\\_.py there are 2 unused includes one for urllib and one for urllib2 both are unused and urlliib2 doesn't exist under python 3\r\n*in dataframe\\_utilities.py the function\r\n```\r\n#!python\r\n\r\ndef asdatetime(timestr):\r\n    tz = tzlocal.get_localzone().zone\r\n    return pandas.Timestamp(timestr, tz=tz)\r\n```\r\ndoesn't work and throws the Exeption:\r\n\r\n```\r\n#!python\r\n\r\nTraceback (most recent call last):\r\n  File \"/Users/janwerkmann/labscript_suite/labscript_utils/excepthook/__init__.py\", line 43, in run\r\n    run_old(*args, **kwargs)\r\n  File \"/Users/janwerkmann/anaconda/envs/snowflakes/lib/python3.6/threading.py\", line 864, in run\r\n    self._target(*self._args, **self._kwargs)\r\n  File \"/Users/janwerkmann/anaconda/envs/snowflakes/lib/python3.6/site-packages/zprocess/__init__.py\", line 67, in f\r\n    six.reraise(type, value, traceback)\r\n  File \"/Users/janwerkmann/anaconda/envs/snowflakes/lib/python3.6/site-packages/six.py\", line 686, in reraise\r\n    raise value\r\n  File \"lyse/__main__.py\", line 1627, in incoming_buffer_loop\r\n    dataframe = get_dataframe_from_shot(filepath)\r\n  File \"/Users/janwerkmann/labscript_suite/lyse/dataframe_utilities.py\", line 116, in get_dataframe_from_shot\r\n    nested_dict = get_nested_dict_from_shot(filepath)\r\n  File \"/Users/janwerkmann/labscript_suite/lyse/dataframe_utilities.py\", line 60, in get_nested_dict_from_shot\r\n    row['run time'] = asdatetime(h5_file.attrs['run time'])\r\n  File \"/Users/janwerkmann/labscript_suite/lyse/dataframe_utilities.py\", line 29, in asdatetime\r\n    return pandas.Timestamp(timestr, tz=tz)\r\n  File \"pandas/_libs/tslib.pyx\", line 402, in pandas._libs.tslib.Timestamp.__new__ (pandas/_libs/tslib.c:10051)\r\n  File \"pandas/_libs/tslib.pyx\", line 1528, in pandas._libs.tslib.convert_to_tsobject (pandas/_libs/tslib.c:28851)\r\nTypeError: Cannot convert input [b'20170612T123722'] of type <class 'bytes'> to Timestamp\r\n```\r\na fix for this is\r\n\r\n```\r\n#!python\r\n\r\ndef asdatetime(timestr):\r\n    tz = tzlocal.get_localzone().zone\r\n    if isinstance(timestr, bytes):\r\n        timestr = timestr.decode('utf-8')\r\n    return pandas.Timestamp(timestr, tz=tz)\r\n```", "markup": "markdown", "html": "<p>As Python 3 porting is not that far away I would like to collect python 3 incompatibilities here.\nAnd also collect fixes so they can be discussed and I don't lose them somewhere in my repos.\nSo far besides the obvious lack of PyQt5 and unicode I found the following problems:</p>\n<ul>\n<li>the module Queue is names queue in python 3 so in __main__.py we should to this:</li>\n</ul>\n<div class=\"codehilite language-python\"><pre><span></span><span class=\"k\">if</span> <span class=\"n\">six</span><span class=\"o\">.</span><span class=\"n\">PY2</span><span class=\"p\">:</span>\n    <span class=\"kn\">import</span> <span class=\"nn\">Queue</span>\n<span class=\"k\">else</span><span class=\"p\">:</span>\n    <span class=\"kn\">import</span> <span class=\"nn\">queue</span> <span class=\"kn\">as</span> <span class=\"nn\">Queue</span>\n</pre></div>\n\n\n<ul>\n<li>in __main__.py  there exists a line:</li>\n</ul>\n<div class=\"codehilite language-python\"><pre><span></span><span class=\"k\">for</span> <span class=\"n\">column_index</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"nb\">sorted</span><span class=\"p\">(</span><span class=\"n\">column_names</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">(),</span> <span class=\"n\">key</span><span class=\"o\">=</span><span class=\"k\">lambda</span> <span class=\"n\">s</span><span class=\"p\">:</span> <span class=\"n\">s</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]):</span>\n</pre></div>\n\n\n<p>which throws the exception:</p>\n<div class=\"codehilite language-python\"><pre><span></span>  <span class=\"n\">File</span> <span class=\"s2\">&quot;lyse/__main__.py&quot;</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">844</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">populate_model</span>\n    <span class=\"k\">for</span> <span class=\"n\">column_index</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"nb\">sorted</span><span class=\"p\">(</span><span class=\"n\">column_names</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">(),</span> <span class=\"n\">key</span><span class=\"o\">=</span><span class=\"k\">lambda</span> <span class=\"n\">s</span><span class=\"p\">:</span> <span class=\"n\">s</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]):</span>\n<span class=\"ne\">TypeError</span><span class=\"p\">:</span> <span class=\"s1\">&#39;&lt;&#39;</span> <span class=\"ow\">not</span> <span class=\"n\">supported</span> <span class=\"n\">between</span> <span class=\"n\">instances</span> <span class=\"n\">of</span> <span class=\"s1\">&#39;tuple&#39;</span> <span class=\"ow\">and</span> <span class=\"s1\">&#39;str&#39;</span>\n</pre></div>\n\n\n<p>A fix for this is:</p>\n<div class=\"codehilite language-python\"><pre><span></span>        <span class=\"k\">def</span> <span class=\"nf\">get_key</span><span class=\"p\">(</span><span class=\"n\">s</span><span class=\"p\">):</span>\n            <span class=\"k\">while</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">s</span><span class=\"p\">,</span> <span class=\"nb\">tuple</span><span class=\"p\">):</span>\n                <span class=\"n\">s</span> <span class=\"o\">=</span> <span class=\"n\">s</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span>\n            <span class=\"k\">return</span> <span class=\"n\">s</span>\n\n        <span class=\"k\">for</span> <span class=\"n\">column_index</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"nb\">sorted</span><span class=\"p\">(</span><span class=\"n\">column_names</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">(),</span> <span class=\"n\">key</span><span class=\"o\">=</span><span class=\"n\">get_key</span><span class=\"p\">):</span>\n</pre></div>\n\n\n<ul>\n<li>in  __init__.py there are 2 unused includes one for urllib and one for urllib2 both are unused and urlliib2 doesn't exist under python 3\n*in dataframe_utilities.py the function</li>\n</ul>\n<div class=\"codehilite language-python\"><pre><span></span><span class=\"k\">def</span> <span class=\"nf\">asdatetime</span><span class=\"p\">(</span><span class=\"n\">timestr</span><span class=\"p\">):</span>\n    <span class=\"n\">tz</span> <span class=\"o\">=</span> <span class=\"n\">tzlocal</span><span class=\"o\">.</span><span class=\"n\">get_localzone</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">zone</span>\n    <span class=\"k\">return</span> <span class=\"n\">pandas</span><span class=\"o\">.</span><span class=\"n\">Timestamp</span><span class=\"p\">(</span><span class=\"n\">timestr</span><span class=\"p\">,</span> <span class=\"n\">tz</span><span class=\"o\">=</span><span class=\"n\">tz</span><span class=\"p\">)</span>\n</pre></div>\n\n\n<p>doesn't work and throws the Exeption:</p>\n<div class=\"codehilite language-python\"><pre><span></span><span class=\"n\">Traceback</span> <span class=\"p\">(</span><span class=\"n\">most</span> <span class=\"n\">recent</span> <span class=\"n\">call</span> <span class=\"n\">last</span><span class=\"p\">):</span>\n  <span class=\"n\">File</span> <span class=\"s2\">&quot;/Users/janwerkmann/labscript_suite/labscript_utils/excepthook/__init__.py&quot;</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">43</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">run</span>\n    <span class=\"n\">run_old</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">&quot;/Users/janwerkmann/anaconda/envs/snowflakes/lib/python3.6/threading.py&quot;</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">864</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">run</span>\n    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_target</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_kwargs</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">&quot;/Users/janwerkmann/anaconda/envs/snowflakes/lib/python3.6/site-packages/zprocess/__init__.py&quot;</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">67</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">f</span>\n    <span class=\"n\">six</span><span class=\"o\">.</span><span class=\"n\">reraise</span><span class=\"p\">(</span><span class=\"nb\">type</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"n\">traceback</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">&quot;/Users/janwerkmann/anaconda/envs/snowflakes/lib/python3.6/site-packages/six.py&quot;</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">686</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">reraise</span>\n    <span class=\"k\">raise</span> <span class=\"n\">value</span>\n  <span class=\"n\">File</span> <span class=\"s2\">&quot;lyse/__main__.py&quot;</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">1627</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">incoming_buffer_loop</span>\n    <span class=\"n\">dataframe</span> <span class=\"o\">=</span> <span class=\"n\">get_dataframe_from_shot</span><span class=\"p\">(</span><span class=\"n\">filepath</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">&quot;/Users/janwerkmann/labscript_suite/lyse/dataframe_utilities.py&quot;</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">116</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">get_dataframe_from_shot</span>\n    <span class=\"n\">nested_dict</span> <span class=\"o\">=</span> <span class=\"n\">get_nested_dict_from_shot</span><span class=\"p\">(</span><span class=\"n\">filepath</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">&quot;/Users/janwerkmann/labscript_suite/lyse/dataframe_utilities.py&quot;</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">60</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">get_nested_dict_from_shot</span>\n    <span class=\"n\">row</span><span class=\"p\">[</span><span class=\"s1\">&#39;run time&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">asdatetime</span><span class=\"p\">(</span><span class=\"n\">h5_file</span><span class=\"o\">.</span><span class=\"n\">attrs</span><span class=\"p\">[</span><span class=\"s1\">&#39;run time&#39;</span><span class=\"p\">])</span>\n  <span class=\"n\">File</span> <span class=\"s2\">&quot;/Users/janwerkmann/labscript_suite/lyse/dataframe_utilities.py&quot;</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">29</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">asdatetime</span>\n    <span class=\"k\">return</span> <span class=\"n\">pandas</span><span class=\"o\">.</span><span class=\"n\">Timestamp</span><span class=\"p\">(</span><span class=\"n\">timestr</span><span class=\"p\">,</span> <span class=\"n\">tz</span><span class=\"o\">=</span><span class=\"n\">tz</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">&quot;pandas/_libs/tslib.pyx&quot;</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">402</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">pandas</span><span class=\"o\">.</span><span class=\"n\">_libs</span><span class=\"o\">.</span><span class=\"n\">tslib</span><span class=\"o\">.</span><span class=\"n\">Timestamp</span><span class=\"o\">.</span><span class=\"fm\">__new__</span> <span class=\"p\">(</span><span class=\"n\">pandas</span><span class=\"o\">/</span><span class=\"n\">_libs</span><span class=\"o\">/</span><span class=\"n\">tslib</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"p\">:</span><span class=\"mi\">10051</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">&quot;pandas/_libs/tslib.pyx&quot;</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">1528</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">pandas</span><span class=\"o\">.</span><span class=\"n\">_libs</span><span class=\"o\">.</span><span class=\"n\">tslib</span><span class=\"o\">.</span><span class=\"n\">convert_to_tsobject</span> <span class=\"p\">(</span><span class=\"n\">pandas</span><span class=\"o\">/</span><span class=\"n\">_libs</span><span class=\"o\">/</span><span class=\"n\">tslib</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"p\">:</span><span class=\"mi\">28851</span><span class=\"p\">)</span>\n<span class=\"ne\">TypeError</span><span class=\"p\">:</span> <span class=\"n\">Cannot</span> <span class=\"n\">convert</span> <span class=\"nb\">input</span> <span class=\"p\">[</span><span class=\"sa\">b</span><span class=\"s1\">&#39;20170612T123722&#39;</span><span class=\"p\">]</span> <span class=\"n\">of</span> <span class=\"nb\">type</span> <span class=\"o\">&lt;</span><span class=\"k\">class</span> <span class=\"err\">&#39;</span><span class=\"nc\">bytes</span><span class=\"s1\">&#39;&gt; to Timestamp</span>\n</pre></div>\n\n\n<p>a fix for this is</p>\n<div class=\"codehilite language-python\"><pre><span></span><span class=\"k\">def</span> <span class=\"nf\">asdatetime</span><span class=\"p\">(</span><span class=\"n\">timestr</span><span class=\"p\">):</span>\n    <span class=\"n\">tz</span> <span class=\"o\">=</span> <span class=\"n\">tzlocal</span><span class=\"o\">.</span><span class=\"n\">get_localzone</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">zone</span>\n    <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">timestr</span><span class=\"p\">,</span> <span class=\"nb\">bytes</span><span class=\"p\">):</span>\n        <span class=\"n\">timestr</span> <span class=\"o\">=</span> <span class=\"n\">timestr</span><span class=\"o\">.</span><span class=\"n\">decode</span><span class=\"p\">(</span><span class=\"s1\">&#39;utf-8&#39;</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">pandas</span><span class=\"o\">.</span><span class=\"n\">Timestamp</span><span class=\"p\">(</span><span class=\"n\">timestr</span><span class=\"p\">,</span> <span class=\"n\">tz</span><span class=\"o\">=</span><span class=\"n\">tz</span><span class=\"p\">)</span>\n</pre></div>", "type": "rendered"}, "assignee": null, "state": "resolved", "version": null, "edited_on": null, "created_on": "2017-07-27T19:43:09.138282+00:00", "milestone": null, "updated_on": "2018-03-23T19:26:15.907661+00:00", "type": "issue", "id": 30}