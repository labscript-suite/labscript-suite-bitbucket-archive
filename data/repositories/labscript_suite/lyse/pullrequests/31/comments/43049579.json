{"links": {"self": {"href": "data/repositories/labscript_suite/lyse/pullrequests/31/comments/43049579.json"}, "html": {"href": "#!/labscript_suite/lyse/pull-requests/31/_/diff#comment-43049579"}}, "deleted": false, "pullrequest": {"type": "pullrequest", "id": 31, "links": {"self": {"href": "data/repositories/labscript_suite/lyse/pullrequests/31.json"}, "html": {"href": "#!/labscript_suite/lyse/pull-requests/31"}}, "title": "Fix a bug in updating the dataframe"}, "content": {"raw": "OK so I've fixed the issues raised in this thread so far.\n\nit's a little bit more code, but since it's in the `except:` handler it doesn't run except when it needs to and so is not a performance hog. And it should only need to run once when a) a new column is being created or b) a column's datatype needs to promoted to 'object' which should only need to occur once per column at most.\n\nRemaining issue is saving over the top of existing save results. Turns out HDF5 does not like you changing your mind about the datatype of an attribute:\n\n\n```\n#!python\n   run.save_result(\"dfgdh\", 1)\n  File \"/home/cjb7/labscript_suite/lyse/__init__.py\", line 170, in save_result\n    h5_file[group].attrs.modify(name, value)\n  File \"/usr/lib/python2.7/dist-packages/h5py/_hl/attrs.py\", line 152, in modify\n    raise TypeError(\"Shape of data is incompatible with existing attribute\")\nTypeError: Shape of data is incompatible with existing attribute\n\n```\nBut that 'bug' has existed for a long time", "markup": "markdown", "html": "<p>OK so I've fixed the issues raised in this thread so far.</p>\n<p>it's a little bit more code, but since it's in the <code>except:</code> handler it doesn't run except when it needs to and so is not a performance hog. And it should only need to run once when a) a new column is being created or b) a column's datatype needs to promoted to 'object' which should only need to occur once per column at most.</p>\n<p>Remaining issue is saving over the top of existing save results. Turns out HDF5 does not like you changing your mind about the datatype of an attribute:</p>\n<div class=\"codehilite language-python\"><pre><span></span>   <span class=\"n\">run</span><span class=\"o\">.</span><span class=\"n\">save_result</span><span class=\"p\">(</span><span class=\"s2\">&quot;dfgdh&quot;</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">&quot;/home/cjb7/labscript_suite/lyse/__init__.py&quot;</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">170</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">save_result</span>\n    <span class=\"n\">h5_file</span><span class=\"p\">[</span><span class=\"n\">group</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">attrs</span><span class=\"o\">.</span><span class=\"n\">modify</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"p\">)</span>\n  <span class=\"n\">File</span> <span class=\"s2\">&quot;/usr/lib/python2.7/dist-packages/h5py/_hl/attrs.py&quot;</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">152</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">modify</span>\n    <span class=\"k\">raise</span> <span class=\"ne\">TypeError</span><span class=\"p\">(</span><span class=\"s2\">&quot;Shape of data is incompatible with existing attribute&quot;</span><span class=\"p\">)</span>\n<span class=\"ne\">TypeError</span><span class=\"p\">:</span> <span class=\"n\">Shape</span> <span class=\"n\">of</span> <span class=\"n\">data</span> <span class=\"ow\">is</span> <span class=\"n\">incompatible</span> <span class=\"k\">with</span> <span class=\"n\">existing</span> <span class=\"n\">attribute</span>\n</pre></div>\n\n\n<p>But that 'bug' has existed for a long time</p>", "type": "rendered"}, "created_on": "2017-08-17T19:37:02.013240+00:00", "user": {"display_name": "Chris Billington", "uuid": "{e363c5a9-5075-4656-afb5-88bd6a6dceeb}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7Be363c5a9-5075-4656-afb5-88bd6a6dceeb%7D"}, "html": {"href": "https://bitbucket.org/%7Be363c5a9-5075-4656-afb5-88bd6a6dceeb%7D/"}, "avatar": {"href": "data/secure.gravatar.com/avatar/9238baf7300c41c0e7294db922899e6ad=httpsavatar-management--avatars.us-west-2.prod.public.atl-paas.netinitialsCB-1.png"}}, "nickname": "cbillington", "type": "user", "account_id": "557058:cbf1bc43-1dc2-477b-9e25-1a8f40fd7ee3"}, "updated_on": "2017-08-17T19:37:02.015707+00:00", "type": "pullrequest_comment", "id": 43049579}