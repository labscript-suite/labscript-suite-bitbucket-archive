{"links": {"self": {"href": "data/repositories/labscript_suite/lyse/pullrequests/61/comments/100911078.json"}, "html": {"href": "#!/labscript_suite/lyse/pull-requests/61/_/diff#comment-100911078"}}, "parent": {"id": 100907353, "links": {"self": {"href": "data/repositories/labscript_suite/lyse/pullrequests/61/comments/100907353.json"}, "html": {"href": "#!/labscript_suite/lyse/pull-requests/61/_/diff#comment-100907353"}}}, "deleted": false, "pullrequest": {"type": "pullrequest", "id": 61, "links": {"self": {"href": "data/repositories/labscript_suite/lyse/pullrequests/61.json"}, "html": {"href": "#!/labscript_suite/lyse/pull-requests/61"}}, "title": "Fix for #48: Make analysis_subprocess.py multiprocessing-friendly"}, "content": {"raw": "I'd thought it unnecessary to terminate the child processes when closing lyse, since they will terminate themselves when heartbeating stops, and in both cases it's terminate() being called, so I would have expected results to be the same. But there's no harm in terminating subprocesses explicitly at shutdown, I can make lyse do that. I don't expect it to work 100% of the time, particularly when things are misbehaving, but it would be good for it to work in the normal case of a clean shutdown of lyse at the very least.\n\nDoes process explorer show you environment variables? I should have zprocess clear the ZPROCESS_PARENTINFO environment variable after it uses it so that it is not inherited by subprocesses and hopefully not visible in process explorer (do you need admin access at least, to view environment variables?). In any case, no, the mere presence of the environment variable doesn't do anything for that subprocess since it does not call the zprocess function to connect to the parent process.\n\nThere is an environment variable though, I think called PYTHONSTARTUP, which Python looks at and can make it run custom start-up code for new interpreters. That could be used to customise subprocesses, such as setting up heartbeating or some such. Though it's pretty magical,not a serious suggestion that we use it!\n\nFor now I'll just make lyse terminate subprocesses normally upon a clean exit. Will solve the majority of the problem. ", "markup": "markdown", "html": "<p>I'd thought it unnecessary to terminate the child processes when closing lyse, since they will terminate themselves when heartbeating stops, and in both cases it's terminate() being called, so I would have expected results to be the same. But there's no harm in terminating subprocesses explicitly at shutdown, I can make lyse do that. I don't expect it to work 100% of the time, particularly when things are misbehaving, but it would be good for it to work in the normal case of a clean shutdown of lyse at the very least.</p>\n<p>Does process explorer show you environment variables? I should have zprocess clear the ZPROCESS_PARENTINFO environment variable after it uses it so that it is not inherited by subprocesses and hopefully not visible in process explorer (do you need admin access at least, to view environment variables?). In any case, no, the mere presence of the environment variable doesn't do anything for that subprocess since it does not call the zprocess function to connect to the parent process.</p>\n<p>There is an environment variable though, I think called PYTHONSTARTUP, which Python looks at and can make it run custom start-up code for new interpreters. That could be used to customise subprocesses, such as setting up heartbeating or some such. Though it's pretty magical,not a serious suggestion that we use it!</p>\n<p>For now I'll just make lyse terminate subprocesses normally upon a clean exit. Will solve the majority of the problem. </p>", "type": "rendered"}, "created_on": "2019-05-04T14:56:08.685047+00:00", "user": {"display_name": "Chris Billington", "uuid": "{e363c5a9-5075-4656-afb5-88bd6a6dceeb}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7Be363c5a9-5075-4656-afb5-88bd6a6dceeb%7D"}, "html": {"href": "https://bitbucket.org/%7Be363c5a9-5075-4656-afb5-88bd6a6dceeb%7D/"}, "avatar": {"href": "data/secure.gravatar.com/avatar/9238baf7300c41c0e7294db922899e6ad=httpsavatar-management--avatars.us-west-2.prod.public.atl-paas.netinitialsCB-1.png"}}, "nickname": "cbillington", "type": "user", "account_id": "557058:cbf1bc43-1dc2-477b-9e25-1a8f40fd7ee3"}, "updated_on": "2019-05-04T14:56:08.693342+00:00", "type": "pullrequest_comment", "id": 100911078}