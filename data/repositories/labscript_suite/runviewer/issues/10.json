{"priority": "major", "kind": "bug", "repository": {"links": {"self": {"href": "data/repositories/labscript_suite/runviewer.json"}, "html": {"href": "#!/labscript_suite/runviewer"}, "avatar": {"href": "data/bytebucket.org/ravatar/{71215673-ad3e-425c-ae04-84cc6c2ca7da}ts=445022"}}, "type": "repository", "name": "runviewer", "full_name": "labscript_suite/runviewer", "uuid": "{71215673-ad3e-425c-ae04-84cc6c2ca7da}"}, "links": {"attachments": {"href": "data/repositories/labscript_suite/runviewer/issues/10/attachments_page=1.json"}, "self": {"href": "data/repositories/labscript_suite/runviewer/issues/10.json"}, "watch": {"href": "https://api.bitbucket.org/2.0/repositories/labscript_suite/runviewer/issues/10/watch"}, "comments": {"href": "data/repositories/labscript_suite/runviewer/issues/10/comments_page=1.json"}, "html": {"href": "#!/labscript_suite/runviewer/issues/10/filepath-issue-possible-qt-api-issues"}, "vote": {"href": "https://api.bitbucket.org/2.0/repositories/labscript_suite/runviewer/issues/10/vote"}}, "reporter": {"display_name": "Chris Billington", "uuid": "{e363c5a9-5075-4656-afb5-88bd6a6dceeb}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7Be363c5a9-5075-4656-afb5-88bd6a6dceeb%7D"}, "html": {"href": "https://bitbucket.org/%7Be363c5a9-5075-4656-afb5-88bd6a6dceeb%7D/"}, "avatar": {"href": "data/secure.gravatar.com/avatar/9238baf7300c41c0e7294db922899e6ad=httpsavatar-management--avatars.us-west-2.prod.public.atl-paas.netinitialsCB-1.png"}}, "nickname": "cbillington", "type": "user", "account_id": "557058:cbf1bc43-1dc2-477b-9e25-1a8f40fd7ee3"}, "title": "Filepath issue, possible Qt API issues", "component": null, "votes": 0, "watches": 2, "content": {"raw": "With current mainline runviewer I get an exception opening a shot file:\r\n\r\n\r\n```\r\n#!python\r\n\r\nTraceback (most recent call last):\r\n  File \"/home/cjb7/labscript_suite/runviewer/__main__.py\", line 291, in on_add_shot\r\n    selected_files = [os.path.abspath(shot_file) for shot_file in selected_files]\r\n  File \"/usr/lib/python2.7/posixpath.py\", line 367, in abspath\r\n    if not isabs(path):\r\n  File \"/usr/lib/python2.7/posixpath.py\", line 61, in isabs\r\n    return s.startswith('/')\r\nAttributeError: 'QString' object has no attribute 'startswith'\r\n```\r\n\r\nThis is clearly because the code `selected_files = [os.path.abspath(shot_file) for shot_file in selected_files]` has been copied from lyse or runmanager, which are configured to use version 2 of the PyQt4 API, in which `selected_files` is a list of ordinary Python strings, whereas runviewer uses the older version 1, in which `selected_files` is a list of QString objects.\r\n\r\nThe fix for me is to change it to: `shot_files = [os.path.abspath(str(shot_file)) for shot_file in shot_files]` to convert the `QStrings` into normal strings, but I'm wondering why this seemingly doesn't break for you, @shaunj. Perhaps the import stuff at the start is making  runviewer use PySide? Perhaps PySide has changed to use the new API?\r\n\r\n`str(shot_file)` will work for either version of the API, so is a fix regardless. I also wonder if this is the source of the confusion over whether some QColor object is a function or not.\r\n\r\nKeep in mind that PyQt API version 2 is the future, so if current code is compatible with it, the following should be added at the top of programs to enable it:\r\n\r\n```\r\n#!python\r\n\r\nimport sip\r\n\r\n# Have to set PyQt API via sip before importing PyQt:\r\nAPI_NAMES = [\"QDate\", \"QDateTime\", \"QString\", \"QTextStream\", \"QTime\", \"QUrl\", \"QVariant\"]\r\nAPI_VERSION = 2\r\nfor name in API_NAMES:\r\n    sip.setapi(name, API_VERSION)\r\n```\r\n\r\nWhich will make it much easier to port to PyQt5 and Python 3, both of which only support the new API.\r\n\r\nI am unsure how PySide factors in to this, the above code doesn't do anything with it, and I'm not sure what API version it uses. PySide apparently doesn't work with Qt 5 or Python 3.5 yet, meaning if we port to those versions before they do, we will probably just have to drop support for PySide.\r\n\r\nThere is also the complication of pyqtgraph - it also chooses what Qt wrapper to use depending on what has already been imported, and so it can influence runviewer's choice because it is imported before runviewer makes the decision. However pyqtgraph appears to have always preferred PyQt4.\r\n\r\nJust some things to consider. I'm sure @philipstarkey has opinions about PySide etc.", "markup": "markdown", "html": "<p>With current mainline runviewer I get an exception opening a shot file:</p>\n<div class=\"codehilite language-python\"><pre><span></span><span class=\"n\">Traceback</span> <span class=\"p\">(</span><span class=\"n\">most</span> <span class=\"n\">recent</span> <span class=\"n\">call</span> <span class=\"n\">last</span><span class=\"p\">):</span>\n  <span class=\"n\">File</span> <span class=\"s2\">&quot;/home/cjb7/labscript_suite/runviewer/__main__.py&quot;</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">291</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">on_add_shot</span>\n    <span class=\"n\">selected_files</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">abspath</span><span class=\"p\">(</span><span class=\"n\">shot_file</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">shot_file</span> <span class=\"ow\">in</span> <span class=\"n\">selected_files</span><span class=\"p\">]</span>\n  <span class=\"n\">File</span> <span class=\"s2\">&quot;/usr/lib/python2.7/posixpath.py&quot;</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">367</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">abspath</span>\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">isabs</span><span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n  <span class=\"n\">File</span> <span class=\"s2\">&quot;/usr/lib/python2.7/posixpath.py&quot;</span><span class=\"p\">,</span> <span class=\"n\">line</span> <span class=\"mi\">61</span><span class=\"p\">,</span> <span class=\"ow\">in</span> <span class=\"n\">isabs</span>\n    <span class=\"k\">return</span> <span class=\"n\">s</span><span class=\"o\">.</span><span class=\"n\">startswith</span><span class=\"p\">(</span><span class=\"s1\">&#39;/&#39;</span><span class=\"p\">)</span>\n<span class=\"ne\">AttributeError</span><span class=\"p\">:</span> <span class=\"s1\">&#39;QString&#39;</span> <span class=\"nb\">object</span> <span class=\"n\">has</span> <span class=\"n\">no</span> <span class=\"n\">attribute</span> <span class=\"s1\">&#39;startswith&#39;</span>\n</pre></div>\n\n\n<p>This is clearly because the code <code>selected_files = [os.path.abspath(shot_file) for shot_file in selected_files]</code> has been copied from lyse or runmanager, which are configured to use version 2 of the PyQt4 API, in which <code>selected_files</code> is a list of ordinary Python strings, whereas runviewer uses the older version 1, in which <code>selected_files</code> is a list of QString objects.</p>\n<p>The fix for me is to change it to: <code>shot_files = [os.path.abspath(str(shot_file)) for shot_file in shot_files]</code> to convert the <code>QStrings</code> into normal strings, but I'm wondering why this seemingly doesn't break for you, @shaunj. Perhaps the import stuff at the start is making  runviewer use PySide? Perhaps PySide has changed to use the new API?</p>\n<p><code>str(shot_file)</code> will work for either version of the API, so is a fix regardless. I also wonder if this is the source of the confusion over whether some QColor object is a function or not.</p>\n<p>Keep in mind that PyQt API version 2 is the future, so if current code is compatible with it, the following should be added at the top of programs to enable it:</p>\n<div class=\"codehilite language-python\"><pre><span></span><span class=\"kn\">import</span> <span class=\"nn\">sip</span>\n\n<span class=\"c1\"># Have to set PyQt API via sip before importing PyQt:</span>\n<span class=\"n\">API_NAMES</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"s2\">&quot;QDate&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;QDateTime&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;QString&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;QTextStream&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;QTime&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;QUrl&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;QVariant&quot;</span><span class=\"p\">]</span>\n<span class=\"n\">API_VERSION</span> <span class=\"o\">=</span> <span class=\"mi\">2</span>\n<span class=\"k\">for</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">API_NAMES</span><span class=\"p\">:</span>\n    <span class=\"n\">sip</span><span class=\"o\">.</span><span class=\"n\">setapi</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">API_VERSION</span><span class=\"p\">)</span>\n</pre></div>\n\n\n<p>Which will make it much easier to port to PyQt5 and Python 3, both of which only support the new API.</p>\n<p>I am unsure how PySide factors in to this, the above code doesn't do anything with it, and I'm not sure what API version it uses. PySide apparently doesn't work with Qt 5 or Python 3.5 yet, meaning if we port to those versions before they do, we will probably just have to drop support for PySide.</p>\n<p>There is also the complication of pyqtgraph - it also chooses what Qt wrapper to use depending on what has already been imported, and so it can influence runviewer's choice because it is imported before runviewer makes the decision. However pyqtgraph appears to have always preferred PyQt4.</p>\n<p>Just some things to consider. I'm sure @philipstarkey has opinions about PySide etc.</p>", "type": "rendered"}, "assignee": {"display_name": "Shaun Johnstone", "uuid": "{652df738-313d-472c-b7b5-a3f8f98a3322}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7B652df738-313d-472c-b7b5-a3f8f98a3322%7D"}, "html": {"href": "https://bitbucket.org/%7B652df738-313d-472c-b7b5-a3f8f98a3322%7D/"}, "avatar": {"href": "data/secure.gravatar.com/avatar/38984f1761fc67ce892911496abee619d=httpsavatar-management--avatars.us-west-2.prod.public.atl-paas.netinitialsSJ-3.png"}}, "nickname": "shjohnst", "type": "user", "account_id": "557058:1b9a15fb-8e4f-407e-b7b9-567c5e1fa1b4"}, "state": "resolved", "version": null, "edited_on": null, "created_on": "2017-06-20T20:19:35.199692+00:00", "milestone": null, "updated_on": "2017-06-27T06:06:21.383347+00:00", "type": "issue", "id": 10}